# apart-audio-remote-control

****
Руководство по аппаратной и программной части контролера удаленного управления предусилителем-селектором Apart Zone4

Нижеописанное устройство было сконструировано в единичном экземпляре. Проверено, отлажено и успешно работает уже более 3-х месяцев на момент написания этого руководства. 
Повторяя это устроство, вы несёте полную ответственности за испорченное оборудование. Однако, если следовать инструкции и не вносить серьезных изменений, всё должно заработать с первого раза.

****
Для организации и настройки связи управляющего устройства (гаджет с операционной системой Android) с селектором Apart4Zone потребуется:
	- NULL-Modem кабель на 9 пинов RS-232 с "папами" на обоих концах. Т.к. контроля передачи данных нет, подойдет способ на 3 провода. 
	- Конвертер последовательного порта в эзернет(далее просто конвертер), в нашем случае готовое устройство USR-TCP232-302. 
	- Всем знакомый lan кабель достаточной длины.
	- Компьютер(далее ПК) под управлением любой ОС с гуем и с lan портом для настройки конвертера.
	- Подразумевается, что в заведении где организуется модернизация акустической системы, точка доступа уже есть и есть возможность подключить в ту же подсеть конвертер.
	- Ну и, разумеется, гаджет под с андроидом и сам селектор Apart Zone4. Вот он на оф.сайте, там же документы для загрузки, в том числе, мануал по RS 232 https://www.apart-audio.com/Category/Details5?cat2=APART&cat3=02.ELECTRONICS&cat4=2080_MATRIX_SYSTEMS&cat5=2080_MATRIX_SYSTEMS&productcode=ZONE4#productDetails

****
Настройка и подключение конвертера к селектору. 

	- Подключить питание к конвертеру. Соединить ПК и конвертер при помощи lan кабеля.
	- Устанавливаем временно на ПК ipv4 192.168.0.201 
	- Если на ПК несколько сетевых карт(например ноут с Wi-Fi), сначала отключаем все сетевые адаптеры, кроме того, к которому подключен конвертер
	- Открываем браузер, в адресную строку вводим айпишник конвертера по умолчанию 192.168.0.7(написан на обратной стороне, там же есть логин и пароль, обычно admin admin). К конвертеру можно скачать заводской софт для натсройки и тестов
	- Попав в веб интерфейс конвертера, сначала настроим доступ к веб-морде в разделе Local IP Config:
			- IP type: Static IP   
			- Static IP: 192.168.1.7  - тут вбиваем сам адрес. Имейте ввиду, 192.168.1.7 - адрес для примера, ваш адрес должен быть в той же подсети, что и точка доступа
	- Нажимаем Save -> в появившемся окне Reboot. Пока конвертер перезагружается, если у вас основная сеть уже настроена, можно смело вытаскивать из ПК lan кабель и совать его в эзернет розетку, связанную с сетью точки доступа Wi-Fi. 
	- На ПК меняем ipv4 в автоматический режим. Соединяем ПК с сетью так же через кабель, либо по Wi-Fi, предварительно взад включив все адптеры.
	- В адресную строку браузера вводим новый установленный IP на веб морду, в нашем случае 192.168.1.7
	- В веб интерфесе переходим к разделу Misc Config:
			- Webserver Port: в нашем случае 80(вроде бы он даже по умолчанию такой же). 
			- Username: что душе угодно
			- Password: аналогично
		!!!логин и пароль - это на доступ к веб интерфейсу, для подключения клиента(приложения на андроид) необходимы только ip и номер порта. 

	- Нажимаем Save -> reboot
	- Перезаходим в веб интерфейс с новыми данными, идем в раздел Serial Port: 
	  тут нам в помощь мануал по RS232 с сайта апарт https://www.apart-audio.com/Category/DownloadOtherDocument?fileName=V_20140626150917387_C_0_F_ZONE4_RS232_Manual.pdf&ext=pdf
			- Bound Rate: 9600  
			- Data Size: 8 
			- Parity: none
			- Stop Bits: 1
			- Local Port Number:4001 
			- Work Mode: TCP Server
	- Save -> reboot
	- Соединяем селектор и конвертер при помощи заготовленного нуль-модема.

****
Мобильное приложение

Приложение состоит из двух слоёв - слой данных и слой представления.

В слое данных:

SharedPreferencesRepository - обертка над SharedPreferences - константы и реализация чтения/сохранения данных, значения по умолчанию.

В слое представления:

SplashActivity - сплэш экран, единственная логика - проверить приложение на первый запуск
OptionsActivity - окно настроек клиент-серверного взаимодействия, дефолтные значения захардкожены в Global.java
SelectorActivity - окно с выбором зон, захардкожено четыре значения, названия зон можно изменять
MainActivity - окно с органами управления. В основе - Rx реализация Socket - SocketClient. После запуска экрана отправляются пакеты с инициализирующими командами. Данные, которые приходят в ответ проверяются на целостность и проверяются на соответствие паттернам для различных настроек (источник, громкость, выключение/включение звука)

Приложение легко кастомизируется под необходимое количество зон и источников, а так же дефолтные настройки, графику и прочее.

В приложении не реализована отправка управляющих команд и чтение параметров относительно таких настроек селектора как: баланс, bass, treble и прочее, за их редким использованием. Для их реализации требуется расширить MainActivity новыми строковыми паттернами из руководства селектора для формирования управляющих значений и парсинга входящих параметров.

Некритичный плавающий баг приложения связан с периодическими нарушениями целостности запросов-ответов, в частности, при одновременной отправке нескольких управляющих команд или разбиением ответа на несколько строк. В приложении добавлен workaround на проверку дефолтной длины ответа (5 символов), но если по какой-то причине такое решение не устраивает - необходимо написать диспетчер для формирования стека управляющих команд и чтения входящих даных с сокета.
